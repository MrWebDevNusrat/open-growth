#!/usr/local/bin/node

// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// Libs
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
const http    = require('request-promise');
const gulp    = require('gulp');
const appkeys = require('./keys.json');

// TODO - create file (concat)
// TODO - upload to EH
// TODO - restart BLOCK
// TODO - wait for BLOCK to boot
// TODO - test BLOCK
// TODO /user/298833/account/298833
//      /app/334158/key/226891/block/2071/editor/2010

// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// Main
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
var $scope = {};

// Login to Global Admin Dashboard
pubnub_login( appkeys.pubnub.email, appkeys.pubnub.password ).then( login => {
    $scope.login = login.result;
    return build();
} ).then( code => {
    $scope.code = code;
    return upload();
} ).then( result => {
    console.log('uploaded!',result);
    return restart();
} ).then( result => {
    console.log('restarting!',result);
} );

// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// Build Event Handler Code
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
function build() {
    var buffer = "";
    return new Promise( ( resolve, reject ) => {
        gulp.src(['./handlers/signals.js','./signals/*.js'])
        .on( 'end',   data  => { resolve(buffer) } )
        .on( 'error', error => { reject(error)   } )
        .on( 'data',  bytes => {
            buffer += bytes.contents.toString().trim();
        } );
    } );
}

// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// Upload Event Handler Code
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
function upload() {
    return http({
        method  : 'PUT'
    ,   json    : true
    ,   uri     : 'https://admin.pubnub.com/api/v1' + 
                  '/blocks/key/226891/event_handler/2010'
    ,   headers : { 'X-Session-Token' : $scope.login.token }
    ,   body    : {
            key_id    : 226891
        ,   block_id  : 2071
        ,   id        : 2010
        ,   code      : $scope.code
        ,   channels  : "opengrowth.signals"
        ,   event     : "js-before-publish"
        ,   type      : "js-before-publish"
        ,   log_level : "debug"
        ,   name      : "Open Growt Signalh Handler"
        ,   output    : "opengrowth.debug"
        }
    }).catch( error => {
        console.error( 'error', error );
    } );
}

// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// Restart Event Handler
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
function restart() {
//curl --data ''  \
    //-H 'Content-Type: application/json'                                   \
    return http({
        method  : 'POST'
    ,   uri     : 'https://admin.pubnub.com/api/v1' + 
                  '/blocks/key/226891/block/2071/start'
    ,   body    : { block_id : 2071, key_id : 226891, action : "start" }
    ,   headers : { 'X-Session-Token' : $scope.login.token }
    ,   json    : true
    }).catch( error => {
        console.error( 'error', error );
    } );
}

// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// Login to PubNub
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
function pubnub_login( email, password ) {
    return http({
        method : 'POST'
    ,   uri    : 'https://admin.pubnub.com/api/me'
    ,   body   : { 'email' : email, 'password' : password }
    ,   json   : true
    }).catch( error => {
        console.error( 'error', error );
    } );
}
